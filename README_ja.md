# CogView4 & CogView3 & CogView-3Plus

[Read this in English](./README.md)
[é˜…è¯»ä¸­æ–‡ç‰ˆ](./README_zh.md)

<div align="center">
<img src=resources/logo.svg width="50%"/>
</div>
<p align="center">
<a href="https://huggingface.co/spaces/THUDM-HF-SPACE/CogView3-Plus-3B-Space" target="_blank"> ğŸ¤— HuggingFace Space</a>  <a href="https://modelscope.cn/studios/ZhipuAI/CogView4" target="_blank">  ğŸ¤–ModelScope Space</a> <a href="resources/WECHAT.md" target="_blank"> ğŸ‘‹ WeChat Community</a>  <a href="https://arxiv.org/abs/2403.05121" target="_blank">ğŸ“š CogView3 Paper</a> 
</p>


![showcase.png](resources/showcase.png)

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ›´æ–°

- ğŸ”¥ğŸ”¥ ```2025/03/04```: [diffusers](https://github.com/huggingface/diffusers) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® **CogView-4** ãƒ¢ãƒ‡ãƒ«ã‚’é©å¿œã—ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã—ã¾ã—ãŸã€‚ã“ã®ãƒ¢ãƒ‡ãƒ«ã¯6Bã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æŒã¡ã€ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ä¸­å›½èªå…¥åŠ›ã¨ä¸­å›½èªã®ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒç”Ÿæˆã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§è©¦ã™ã“ã¨ãŒã§ãã¾ã™ [ã“ã¡ã‚‰](https://huggingface.co/spaces/THUDM-HF-SPACE/CogView4)ã€‚
- ```2024/10/13```: [diffusers](https://github.com/huggingface/diffusers) ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® **CogView-3Plus-3B** ãƒ¢ãƒ‡ãƒ«ã‚’é©å¿œã—ã€ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã—ã¾ã—ãŸã€‚ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§è©¦ã™ã“ã¨ãŒã§ãã¾ã™ [ã“ã¡ã‚‰](https://huggingface.co/spaces/THUDM-HF-SPACE/CogView3-Plus-3B-Space)ã€‚
- ```2024/9/29```: **CogView3** ã¨ **CogView-3Plus-3B** ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹åŒ–ã—ã¾ã—ãŸã€‚**CogView3** ã¯ã‚«ã‚¹ã‚±ãƒ¼ãƒ‰æ‹¡æ•£ã«åŸºã¥ããƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ã§ã€ãƒªãƒ¬ãƒ¼ãƒ‡ã‚£ãƒ•ãƒ¥ãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚**CogView-3Plus** ã¯æ–°ãŸã«é–‹ç™ºã•ã‚ŒãŸDiffusion Transformerã«åŸºã¥ããƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒç”Ÿæˆãƒ¢ãƒ‡ãƒ«ã®ã‚·ãƒªãƒ¼ã‚ºã§ã™ã€‚

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»

- [X] diffusers ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®é©å¿œ
- [ ] ComfyUI diffusers ãƒãƒ¼ãƒ‰
- [ ] å¾®èª¿æ•´ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚­ãƒƒãƒˆ
- [ ] ControlNet ãƒ¢ãƒ‡ãƒ«ã®ãƒªãƒªãƒ¼ã‚¹
- [ ] Cogã‚·ãƒªãƒ¼ã‚ºã®å¾®èª¿æ•´ã‚­ãƒƒãƒˆ

## ãƒ¢ãƒ‡ãƒ«ç´¹ä»‹

### ãƒ¢ãƒ‡ãƒ«æ¯”è¼ƒ

<table style="border-collapse: collapse; width: 100%;">
  <tr>
    <th style="text-align: center;">ãƒ¢ãƒ‡ãƒ«å</th>
    <th style="text-align: center;">CogView4</th>
    <th style="text-align: center;">CogView3-Plus-3B</th>
  </tr>
    <td style="text-align: center;">è§£åƒåº¦</td>
    <td colspan="2" style="text-align: center;">
            512 <= H, W <= 2048 <br>
            H * W <= 2^{21} <br>
            H, W \mod 32 = 0
    </td>
  <tr>
    <td style="text-align: center;">æ¨è«–ç²¾åº¦</td>
    <td colspan="2" style="text-align: center;">BF16, FP32 ã®ã¿ã‚µãƒãƒ¼ãƒˆ</td>
  <tr>
  <td style="text-align: center;">ã‚¨ãƒ³ã‚³ãƒ¼ãƒ€</td>
  <td style="text-align: center;"><a href="https://huggingface.co/THUDM/glm-4-9b-hf" target="_blank">GLM-4-9B</a></td>
  <td style="text-align: center;"><a href="https://huggingface.co/google/t5-v1_1-xxl" target="_blank">T5-XXL</a></td>
</tr>
  <tr>
    <td style="text-align: center;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨€èª</td>
    <td style="text-align: center;">ä¸­å›½èªã€è‹±èª</td>
    <td style="text-align: center;">è‹±èª</td>
  </tr>
  <tr>
    <td style="text-align: center;">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé•·ã•ã®åˆ¶é™</td>
    <td style="text-align: center;">1024 ãƒˆãƒ¼ã‚¯ãƒ³</td>
    <td style="text-align: center;">224 ãƒˆãƒ¼ã‚¯ãƒ³</td>
  </tr>
  <tr>
    <td style="text-align: center;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯</td>
    <td style="text-align: center;"><a href="https://huggingface.co/THUDM/CogView4-6B">ğŸ¤— HuggingFace</a><br><a href="https://modelscope.cn/models/ZhipuAI/CogView4-6B">ğŸ¤– ModelScope</a><br><a href="https://wisemodel.cn/models/ZhipuAI/CogView4-6B">ğŸŸ£ WiseModel</a></td>
    <td style="text-align: center;"><a href="https://huggingface.co/THUDM/CogView3-Plus-3B">ğŸ¤— HuggingFace</a><br><a href="https://modelscope.cn/models/ZhipuAI/CogView3-Plus-3B">ğŸ¤– ModelScope</a><br><a href="https://wisemodel.cn/models/ZhipuAI/CogView3-Plus-3B">ğŸŸ£ WiseModel</a></td>
  </tr>
</table>

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡

DITãƒ¢ãƒ‡ãƒ«ã¯ `BF16` ç²¾åº¦ã¨ `batchsize=4` ã§ãƒ†ã‚¹ãƒˆã•ã‚Œã€çµæœã¯ä»¥ä¸‹ã®è¡¨ã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ï¼š

| è§£åƒåº¦         | enable_model_cpu_offload OFF | enable_model_cpu_offload ON | enable_model_cpu_offload ON </br> Text Encoder 4bit | 
|-------------|------------------------------|-----------------------------|-----------------------------------------------------| 
| 512 * 512   | 33GB                         | 20GB                        | 13G                                                 | 
| 1280 * 720  | 35GB                         | 20GB                        | 13G                                                 | 
| 1024 * 1024 | 35GB                         | 20GB                        | 13G                                                 | 
| 1920 * 1280 | 39GB                         | 20GB                        | 14G                                                 | 
| 2048 * 2048 | 43GB                         | 21GB                        | 14G                                                 | 

ã•ã‚‰ã«ã€ãƒ—ãƒ­ã‚»ã‚¹ãŒå¼·åˆ¶çµ‚äº†ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã«ã€å°‘ãªãã¨ã‚‚`32GB`ã®RAMã‚’æŒã¤ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¨å¥¨ã—ã¾ã™ã€‚

### ãƒ¢ãƒ‡ãƒ«æŒ‡æ¨™

è¤‡æ•°ã®ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯ã§ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã€ä»¥ä¸‹ã®ã‚¹ã‚³ã‚¢ã‚’é”æˆã—ã¾ã—ãŸï¼š

#### DPG-Bench

| ãƒ¢ãƒ‡ãƒ«        | å…¨ä½“   | ã‚°ãƒ­ãƒ¼ãƒãƒ«    | ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£    | å±æ€§ | é–¢ä¿‚  | ãã®ä»–     |
|--------------|-----------|-----------|-----------|-----------|-----------|-----------|
| SDXL         | 74.65     | 83.27     | 82.43     | 80.91     | 86.76     | 80.41     |
| PixArt-alpha | 71.11     | 74.97     | 79.32     | 78.60     | 82.57     | 76.96     |
| SD3-Medium   | 84.08     | 87.90     | **91.01** | 88.83     | 80.70     | 88.68     |
| DALL-E 3      | 83.50     | **90.97** | 89.61     | 88.39     | 90.58     | 89.83     |
| Flux.1-dev   | 83.79     | 85.80     | 86.79     | 89.98     | 90.04     | **89.90** |
| Janus-Pro-7B | 84.19     | 86.90     | 88.90     | 89.40     | 89.32     | 89.48     |
| **CogView4-6B** | **85.13** | 83.85     | 90.35     | **91.17** | **91.14** | 87.29     |

#### GenEval

| ãƒ¢ãƒ‡ãƒ«           | å…¨ä½“  | å˜ä¸€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | äºŒã¤ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ | ã‚«ã‚¦ãƒ³ãƒˆ | è‰²   | ä½ç½® | è‰²ã®å±æ€§ |
|-----------------|----------|-------------|----------|----------|----------|----------|-------------------|
| SDXL            | 0.55     | 0.98        | 0.74     | 0.39     | 0.85     | 0.15     | 0.23              |
| PixArt-alpha    | 0.48     | 0.98        | 0.50     | 0.44     | 0.80     | 0.08     | 0.07              |
| SD3-Medium      | 0.74     | **0.99**    | **0.94** | 0.72     | 0.89     | 0.33     | 0.60              |
| DALL-E 3        | 0.67     | 0.96        | 0.87     | 0.47     | 0.83     | 0.43     | 0.45              |
| Flux.1-dev      | 0.66     | 0.98        | 0.79     | **0.73** | 0.77     | 0.22     | 0.45              |
| Janus-Pro-7B    | **0.80** | **0.99**    | 0.89     | 0.59     | **0.90** | **0.79** | **0.66**          |
| **CogView4-6B** | 0.73     | **0.99**    | 0.86     | 0.66     | 0.79     | 0.48     | 0.58              |

#### T2I-CompBench

| ãƒ¢ãƒ‡ãƒ«           | è‰²      | å½¢      | ãƒ†ã‚¯ã‚¹ãƒãƒ£    | 2D-ç©ºé–“ | 3D-ç©ºé–“ | æ•°é‡   | éç©ºé–“ Clip | è¤‡é›‘ãª3-in-1 |
|-----------------|------------|------------|------------|------------|------------|------------|------------------|----------------|
| SDXL            | 0.5879     | 0.4687     | 0.5299     | 0.2133     | 0.3566     | 0.4988     | 0.3119           | 0.3237         |
| PixArt-alpha    | 0.6690     | 0.4927     | 0.6477     | 0.2064     | 0.3901     | 0.5058     | **0.3197**       | 0.3433         |
| SD3-Medium      | **0.8132** | 0.5885     | **0.7334** | **0.3200** | **0.4084** | 0.6174     | 0.3140           | 0.3771         |
| DALL-E 3        | 0.7785     | **0.6205** | 0.7036     | 0.2865     | 0.3744     | 0.5880     | 0.3003           | 0.3773         |
| Flux.1-dev      | 0.7572     | 0.5066     | 0.6300     | 0.2700     | 0.3992     | 0.6165     | 0.3065           | 0.3628         |
| Janus-Pro-7B    | 0.5145     | 0.3323     | 0.4069     | 0.1566     | 0.2753     | 0.4406     | 0.3137           | 0.3806         |
| **CogView4-6B** | 0.7786     | 0.5880     | 0.6983     | 0.3075     | 0.3708     | **0.6626** | 0.3056           | **0.3869**     |

## ä¸­å›½èªãƒ†ã‚­ã‚¹ãƒˆã®æ­£ç¢ºæ€§è©•ä¾¡

| ãƒ¢ãƒ‡ãƒ«           | ç²¾åº¦  | ãƒªã‚³ãƒ¼ãƒ«     | F1ã‚¹ã‚³ã‚¢   | pick@4     |
|-----------------|------------|------------|------------|------------|
| Kolors          | 0.6094     | 0.1886     | 0.2880     | 0.1633     |
| **CogView4-6B** | **0.6969** | **0.5532** | **0.6168** | **0.3265** |

## æ¨è«–ãƒ¢ãƒ‡ãƒ«

### ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ€é©åŒ–

CogView4ã‚·ãƒªãƒ¼ã‚ºã®ãƒ¢ãƒ‡ãƒ«ã¯é•·æ–‡ã®åˆæˆç”»åƒèª¬æ˜ã§ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ç”»åƒç”Ÿæˆã‚’è¡Œã†å‰ã«å¤§è¦æ¨¡è¨€èªãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒªãƒ©ã‚¤ãƒˆã™ã‚‹ã“ã¨ã‚’å¼·ããŠå‹§ã‚ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šç”Ÿæˆå“è³ªãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚

[ä¾‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](inference/prompt_optimize.py)ã‚’æä¾›ã—ã¦ã„ã¾ã™ã€‚ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ãƒªãƒ•ã‚¡ã‚¤ãƒ³ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚`CogView4` ã¨ `CogView3` ãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–ã«ã¯ç•°ãªã‚‹few-shotãŒä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚åŒºåˆ¥ãŒå¿…è¦ã§ã™ã€‚

```shell
cd inference
python prompt_optimize.py --api_key "Zhipu AI API Key" --prompt {your prompt} --base_url "https://open.bigmodel.cn/api/paas/v4" --model "glm-4-plus" --cogview_version "cogview4"
```

### æ¨è«–ãƒ¢ãƒ‡ãƒ«

`BF16` ç²¾åº¦ã§ãƒ¢ãƒ‡ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```python
from diffusers import CogView4Pipeline
import torch

pipe = CogView4Pipeline.from_pretrained("THUDM/CogView4-6B", torch_dtype=torch.bfloat16).to("cuda")

# GPUãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æ¸›ã‚‰ã™ãŸã‚ã«é–‹ã
pipe.enable_model_cpu_offload()
pipe.vae.enable_slicing()
pipe.vae.enable_tiling()

prompt = "A vibrant cherry red sports car sits proudly under the gleaming sun, its polished exterior smooth and flawless, casting a mirror-like reflection. The car features a low, aerodynamic body, angular headlights that gaze forward like predatory eyes, and a set of black, high-gloss racing rims that contrast starkly with the red. A subtle hint of chrome embellishes the grille and exhaust, while the tinted windows suggest a luxurious and private interior. The scene conveys a sense of speed and elegance, the car appearing as if it's about to burst into a sprint along a coastal road, with the ocean's azure waves crashing in the background."
image = pipe(
    prompt=prompt,
    guidance_scale=3.5,
    num_images_per_prompt=1,
    num_inference_steps=50,
    width=1024,
    height=1024,
).images[0]

image.save("cogview4.png")
```

ãã®ä»–ã®æ¨è«–ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã¯ã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

1. `int4` ã‚’ä½¿ç”¨ã—ã¦ `text encoder` ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã€å®Œå…¨ãªæ³¨é‡ˆä»˜ãæ¨è«–ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã™ã‚‹ã«ã¯ [ã“ã¡ã‚‰](inference/cli_demo_cogview4.py)ã€‚
2. `gradio` GUI DEMO ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹ã«ã¯ [ã“ã¡ã‚‰](inference/gradio_web_demo.py)

## ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã¨CogView3ãƒ¢ãƒ‡ãƒ«ã¯ [Apache 2.0](./LICENSE) ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ä¸‹ã§æä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã®è²¢çŒ®ã‚’æ­“è¿ã—ã€æ„Ÿè¬ã—ã¾ã™ã€‚è²¢çŒ®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã¯ [ã“ã¡ã‚‰](resources/contribute.md) ã§ç¢ºèªã§ãã¾ã™ã€‚
